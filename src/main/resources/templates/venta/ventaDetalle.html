<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
    <head>
        <title>Detalle de Venta | Sistema Comercial</title>

        <!-- Estilos específicos para la página de detalle de ventas -->
    <th:block layout:fragment="styles">
        <link rel="stylesheet" th:href="@{/css/StyleVD.css}">
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-file-invoice me-2"></i> Detalle de Venta
                </h2>
                <div>
                    <a th:href="@{/ventas}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>Volver a Ventas
                    </a>
                    <button class="btn btn-primary" onclick="imprimirFactura()">
                        <i class="fas fa-print me-2"></i>Imprimir
                    </button>
                </div>
            </div>

            <div th:if="${venta != null}" class="card card-custom">
                <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Factura: <span th:text="${venta.numeroFactura}">N/A</span></h5>
                    <span th:switch="${venta.estado?.name()}" class="badge">
                        <span th:case="COMPLETADA" class="badge badge-completed">Completada</span>
                        <span th:case="PENDIENTE" class="badge badge-pending">Pendiente</span>
                        <span th:case="CANCELADA" class="badge badge-cancelled">Cancelada</span>
                        <span th:case="*" th:text="${venta.estado}" class="badge bg-secondary"></span>
                    </span>
                </div>
                <div class="card-body">
                    <!-- Información de la venta -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">Información del Cliente</h6>
                            <div class="mb-2">
                                <strong>Cliente:</strong> 
                                <span th:if="${venta.cliente != null}" 
                                      th:text="${venta.cliente.nombre} + ' ' + ${venta.cliente.apellido}">Cliente</span>
                                <span th:unless="${venta.cliente != null}" class="text-muted">Cliente no disponible</span>
                            </div>
                            <div th:if="${venta.cliente?.correoElectronico != null}" class="mb-2">
                                <strong>Email:</strong> <span th:text="${venta.cliente.correoElectronico}">email</span>
                            </div>
                            <div th:if="${venta.cliente?.celular != null}" class="mb-2">
                                <strong>Teléfono:</strong> <span th:text="${venta.cliente.celular}">celular</span>
                            </div>
                            <div th:if="${venta.cliente?.direccion != null}" class="mb-2">
                                <strong>Dirección:</strong> <span th:text="${venta.cliente.direccion}">dirección</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Información de la Venta</h6>
                            <div class="mb-2">
                                <strong>Fecha:</strong> 
                                <span th:text="${#temporals.format(venta.fecha, 'dd/MM/yyyy')}">fecha</span>
                            </div>
                            <div class="mb-2">
                                <strong>Método de Pago:</strong> 
                                <span th:switch="${venta.metodoPago?.name()}">
                                    <span th:case="EFECTIVO" class="badge bg-success">Efectivo</span>
                                    <span th:case="TARJETA_CREDITO" class="badge bg-primary">Tarjeta</span>
                                    <span th:case="TRANSFERENCIA" class="badge bg-info">Transferencia</span>
                                    <span th:case="CHEQUE" class="badge bg-warning">Cheque</span>
                                    <span th:case="*" th:text="${venta.metodoPago}" class="badge bg-secondary"></span>
                                </span>
                            </div>
                            <div class="mb-2">
                                <strong>Vendedor:</strong> 
                                <span th:if="${venta.empleado != null}"
                                      th:text="${venta.empleado.nombre} + ' ' + ${venta.empleado.apellido}">Vendedor</span>
                                <span th:unless="${venta.empleado != null}" class="text-muted">No asignado</span>
                            </div>
                            <div th:if="${venta.fechaCreacion != null}" class="mb-2">
                                <strong>Fecha de Registro:</strong> 
                                <span th:text="${#temporals.format(venta.fechaCreacion, 'dd/MM/yyyy HH:mm')}">fecha registro</span>
                            </div>
                        </div>
                    </div>

                    <!-- Detalles de productos -->
                    <h6 class="text-muted mb-3">Productos Vendidos</h6>
                    <div class="table-responsive mb-4">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unitario</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="detalle : ${venta.detalles}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img th:if="${detalle.producto?.imagen != null}" 
                                                 th:src="@{/images/productos/{imagen}(imagen=${detalle.producto.imagen})}" 
                                                 th:alt="${detalle.producto?.nombre}" 
                                                 class="sale-item-img me-3">
                                            <div>
                                                <div class="fw-bold">
                                                    <span th:if="${detalle.producto != null}" 
                                                          th:text="${detalle.producto.nombre}">Producto</span>
                                                    <span th:unless="${detalle.producto != null}" class="text-muted">Producto no disponible</span>
                                                </div>
                                                <div th:if="${detalle.producto?.descripcion != null}">
                                                    <small class="text-muted" th:text="${detalle.producto.descripcion}">descripción</small>
                                                </div>
                                                <div th:if="${detalle.producto?.codigo != null}">
                                                    <small class="text-muted">Código: <span th:text="${detalle.producto.codigo}">código</span></small>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center" th:text="${detalle.cantidad}">1</td>
                                    <td class="text-end">
                                        $<span th:text="${#numbers.formatDecimal(detalle.precioUnitario, 0, 'COMMA', 2, 'POINT')}">0</span>
                                    </td>
                                    <td class="text-end">
                                        $<span th:text="${#numbers.formatDecimal(detalle.total, 0, 'COMMA', 2, 'POINT')}">0</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Resumen de totales -->
                    <div class="row justify-content-end">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span>$<span th:text="${#numbers.formatDecimal(venta.subtotal, 0, 'COMMA', 2, 'POINT')}">0</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Descuento:</span>
                                        <span>$<span th:text="${#numbers.formatDecimal(venta.descuento, 0, 'COMMA', 2, 'POINT')}">0</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>IVA (19%):</span>
                                        <span>$<span th:text="${#numbers.formatDecimal(venta.iva, 0, 'COMMA', 2, 'POINT')}">0</span></span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between fw-bold fs-5">
                                        <span>Total:</span>
                                        <span>$<span th:text="${#numbers.formatDecimal(venta.total, 0, 'COMMA', 2, 'POINT')}">0</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notas -->
                    <div th:if="${venta.notas != null and venta.notas != ''}" class="mt-4">
                        <h6 class="text-muted">Notas</h6>
                        <div class="border rounded p-3 bg-light">
                            <span th:text="${venta.notas}">Notas de la venta</span>
                        </div>
                    </div>

                    <!-- Acciones adicionales -->
                    <div class="mt-4 pt-3 border-top">
                        <div class="btn-group" role="group">
                            <a th:href="@{/ventas/editar/{id}(id=${venta.idVenta})}" 
                               class="btn btn-outline-primary" 
                               th:if="${venta.estado?.name() != 'COMPLETADA' and venta.estado?.name() != 'CANCELADA'}">
                                <i class="fas fa-edit me-2"></i>Editar Venta
                            </a>

                            <form th:action="@{/ventas/completar/{id}(id=${venta.idVenta})}" 
                                  method="post" class="d-inline"
                                  th:if="${venta.estado?.name() == 'PENDIENTE'}">
                                <button type="submit" class="btn btn-outline-success ms-2">
                                    <i class="fas fa-check me-2"></i>Completar Venta
                                </button>
                            </form>

                            <form th:action="@{/ventas/cancelar/{id}(id=${venta.idVenta})}" 
                                  method="post" class="d-inline"
                                  th:if="${venta.estado?.name() != 'CANCELADA'}">
                                <button type="submit" class="btn btn-outline-danger ms-2" 
                                        th:onclick="|return confirm('¿Está seguro de cancelar esta venta?')|">
                                    <i class="fas fa-times me-2"></i>Cancelar Venta
                                </button>
                            </form>

                            <form th:action="@{/ventas/eliminar/{id}(id=${venta.idVenta})}" 
                                  method="post" class="d-inline"
                                  th:if="${venta.estado?.name() == 'CANCELADA'}">
                                <button type="submit" class="btn btn-outline-danger ms-2" 
                                        th:onclick="|return confirm('¿Está seguro de eliminar esta venta? Esta acción no se puede deshacer.')|">
                                    <i class="fas fa-trash me-2"></i>Eliminar Venta
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div th:if="${venta == null}" class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No se encontró la venta solicitada.
            </div>
        </div>
    </div>

    <!-- Scripts específicos para la página de detalle de ventas -->
<th:block layout:fragment="scripts">
    <script th:src="@{/js/ventaDetalle.js}"></script>
</th:block>
</body>
</html>