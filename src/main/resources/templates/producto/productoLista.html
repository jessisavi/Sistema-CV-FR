<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      layout:decorate="~{base}">
    <head>
        <title>Lista de Productos | Sistema CV</title>

        <!-- Estilos específicos para productos -->
    <th:block layout:fragment="styles">
        <link rel="stylesheet" th:href="@{/css/StylePL.css}">
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="container-fluid">
            <!-- Mensajes de éxito y error -->
            <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${mensaje}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Header de la página -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1"><i class="fas fa-boxes me-2"></i> Lista de Productos</h2>
                    <p class="text-muted mb-0">Gestión completa del inventario de productos</p>
                </div>
                <div>
                    <a th:href="@{/productos/nuevo}" class="btn btn-custom me-2">
                        <i class="fas fa-plus me-2"></i>Nuevo Producto
                    </a>
                    <button class="btn btn-outline-custom" onclick="exportarProductos()">
                        <i class="fas fa-file-export me-2"></i>Exportar
                    </button>
                </div>
            </div>

            <!-- Tarjetas de estadísticas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card card-custom">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title text-muted">Total Productos</h5>
                                    <h2 class="card-text text-primary" th:text="${totalProductos}">0</h2>
                                </div>
                                <div class="icon-circle bg-primary">
                                    <i class="fas fa-box text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title text-muted">Stock Bajo</h5>
                                    <h2 class="card-text text-warning" th:text="${stockBajo}">0</h2>
                                </div>
                                <div class="icon-circle bg-warning">
                                    <i class="fas fa-exclamation-triangle text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title text-muted">Sin Stock</h5>
                                    <h2 class="card-text text-danger" th:text="${sinStock}">0</h2>
                                </div>
                                <div class="icon-circle bg-danger">
                                    <i class="fas fa-times-circle text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title text-muted">Stock Óptimo</h5>
                                    <h2 class="card-text text-success" th:text="${stockOptimo}">0</h2>
                                </div>
                                <div class="icon-circle bg-success">
                                    <i class="fas fa-check-circle text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros y búsqueda -->
            <div class="card card-custom mb-4">
                <div class="card-header card-header-custom">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros y Búsqueda</h5>
                </div>
                <div class="card-body">
                    <form method="get" th:action="@{/productos}" id="filtroForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" name="busqueda" class="form-control" 
                                           placeholder="Buscar por nombre, código o descripción..." 
                                           th:value="${param.busqueda}">
                                    <button type="submit" class="btn btn-custom">
                                        <i class="fas fa-search me-1"></i>Buscar
                                    </button>
                                    <th:block th:if="${param.busqueda}">
                                        <a th:href="@{/productos}" class="btn btn-outline-secondary">
                                            <i class="fas fa-times"></i>
                                        </a>
                                    </th:block>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" name="categoria" id="categoriaSelect">
                                    <option value="">Todas las categorías</option>
                                    <option th:each="categoria : ${categorias}"
                                            th:value="${categoria.idcategoria}"
                                            th:text="${categoria.nombre}"
                                            th:selected="${param.categoria == categoria.idcategoria}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <a th:href="@{/productos}" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-refresh me-1"></i>Limpiar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tabla de productos -->
            <div class="card card-custom">
                <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Productos 
                            <th:block th:if="${param.busqueda}">
                                - Resultados para: "<span th:text="${param.busqueda}"></span>"
                            </th:block>
                            <th:block th:if="${param.categoria}">
                                - Categoría: 
                                <span th:each="categoria : ${categorias}" 
                                      th:if="${categoria.idcategoria == param.categoria}"
                                      th:text="${categoria.nombre}">
                                </span>
                            </th:block>
                        </h5>
                    </div>
                    <div>
                        <span class="badge bg-primary fs-6" th:text="${totalProductos} + ' productos'">0 productos</span>
                    </div>
                </div>
                <div class="card-body">
                    <th:block th:if="${not empty productos}">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="50">#</th>
                                        <th>Producto</th>
                                        <th width="120">Código</th>
                                        <th width="150">Categoría</th>
                                        <th width="120">Precio</th>
                                        <th width="120">Stock</th>
                                        <th width="150">Ubicación</th>
                                        <th width="150">Proveedor</th>
                                        <th width="120">Estado</th>
                                        <th width="100" class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="producto, status : ${productos}">
                                        <td class="fw-bold text-muted" th:text="${status.index + 1}">1</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img th:src="@{${producto.imagenUrl != null ? producto.imagenUrl : '/static/images/productos/default-product.jpg'}}" 
                                                     th:alt="${producto.nombre}" 
                                                     class="product-img me-3"
                                                     onerror="this.src='/static/images/productos/default-product.jpg'">
                                                <div>
                                                    <h6 class="mb-1 fw-bold" th:text="${producto.nombre}">Nombre Producto</h6>
                                                    <div class="text-muted small">
                                                        <div>Color: <span th:text="${producto.color != null ? producto.color : 'N/A'}">N/A</span></div>
                                                        <th:block th:if="${producto.rectificado != null and producto.rectificado != '0'}">
                                                            <span class="badge bg-info me-1">Rectificado</span>
                                                        </th:block>
                                                        <th:block th:if="${producto.acabado != null}">
                                                            <span class="badge bg-secondary" th:text="${producto.acabado}">Acabado</span>
                                                        </th:block>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-dark fs-6" th:text="${producto.codigo}">COD-001</span>
                                        </td>
                                        <td>
                                            <span class="badge badge-category ceramica" th:text="${producto.categoriaNombre != null ? producto.categoriaNombre : 'Sin categoría'}">
                                                Categoría
                                            </span>
                                        </td>
                                        <td>
                                            <div class="fw-bold text-success" th:text="'$' + ${#numbers.formatDecimal(producto.precio, 0, 'COMMA', 0, 'POINT')}">$0</div>
                                            <small class="text-muted" th:text="${producto.MT != null ? producto.MT : 'UD'}">M2</small>
                                        </td>
                                        <td th:classappend="${producto.stock == 0 ? 'stock-low' : (producto.stock <= 10 ? 'stock-low' : (producto.stock <= 20 ? 'stock-medium' : 'stock-high'))}" 
                                            class="fw-bold" th:text="${producto.stock} + ' und'">0 und</td>
                                        <td>
                                <th:block th:if="${producto.ubicacion != null}">
                                    <span class="badge bg-light text-dark border">
                                        <i class="fas fa-map-marker-alt me-1 text-primary"></i>
                                        <span th:text="${producto.ubicacion}">Ubicación</span>
                                    </span>
                                </th:block>
                                <th:block th:unless="${producto.ubicacion != null}">
                                    <span class="text-muted small">No asignada</span>
                                </th:block>
                                </td>
                                <td>
                                    <span class="fw-medium" th:text="${producto.proveedorNombre != null ? producto.proveedorNombre : 'No asignado'}">
                                        Proveedor
                                    </span>
                                </td>
                                <td>
                                <th:block th:switch="${producto.stock}">
                                    <span th:case="0" class="badge bg-danger">Sin Stock</span>
                                    <span th:case="*" th:if="${producto.stock <= 10}" class="badge bg-warning">Stock Bajo</span>
                                    <span th:case="*" th:if="${producto.stock > 10 and producto.stock <= 20}" class="badge bg-info">Stock Medio</span>
                                    <span th:case="*" th:if="${producto.stock > 20}" class="badge bg-success">Stock Óptimo</span>
                                </th:block>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a th:href="@{/productos/{id}(id=${producto.idproducto})}" 
                                           class="btn btn-outline-primary" 
                                           title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a th:href="@{/productos/editar/{id}(id=${producto.idproducto})}" 
                                           class="btn btn-outline-secondary" 
                                           title="Editar producto">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </th:block>
                    <th:block th:unless="${not empty productos}">
                        <div class="text-center py-5">
                            <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">No se encontraron productos</h4>
                            <p class="text-muted mb-4">
                            <th:block th:if="${param.busqueda}">
                                No hay productos que coincidan con "<span th:text="${param.busqueda}"></span>"
                            </th:block>
                            <th:block th:if="${param.categoria}">
                                No hay productos en esta categoría
                            </th:block>
                            <th:block th:unless="${param.busqueda or param.categoria}">
                                No hay productos registrados en el sistema
                            </th:block>
                            </p>
                            <a th:href="@{/productos/nuevo}" class="btn btn-custom">
                                <i class="fas fa-plus me-2"></i>Agregar Primer Producto
                            </a>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts específicos para productos -->
<th:block layout:fragment="scripts">
    <script th:src="@{/js/productoLista.js}"></script>
</th:block>
</body>
</html>