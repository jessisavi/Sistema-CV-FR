<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
    <head>
        <title>Informes y Estadísticas - Sistema CV</title>

        <!-- Estilos específicos para informes -->
    <th:block layout:fragment="styles">
        <link rel="stylesheet" th:href="@{/css/StyleINFO.css}">
        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </th:block>
</head>
<body>
    <!-- Contenido principal -->
    <div layout:fragment="content">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Generación de Informes</h2>
                <button class="btn btn-custom" id="btnExportarTodos">
                    <i class="fas fa-file-export me-2"></i>Exportar Todos
                </button>
            </div>

            <!-- Tarjetas de resumen -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card card-custom report-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title text-success">Ventas</h5>
                                    <h3 class="text-success" th:text="${estadisticasVentas?.totalIngresos != null} ? '$' + ${#numbers.formatDecimal(estadisticasVentas.totalIngresos, 0, 'DEFAULT', 0, 'DEFAULT')} : '$0'">$0</h3>
                                    <p class="card-text" th:text="${estadisticasVentas?.totalVentas != null} ? ${estadisticasVentas.totalVentas} + ' transacciones' : '0 transacciones'">0 transacciones</p>
                                </div>
                                <div class="report-icon">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom report-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title text-primary">Cotizaciones</h5>
                                    <h3 class="text-primary" th:text="${estadisticasCotizaciones?.totalCotizaciones != null} ? ${estadisticasCotizaciones.totalCotizaciones} : '0'">0</h3>
                                    <p class="card-text" th:text="${estadisticasCotizaciones?.aprobadas != null} ? ${estadisticasCotizaciones.aprobadas} + ' aprobadas' : '0 aprobadas'">0 aprobadas</p>
                                </div>
                                <div class="report-icon">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom report-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title text-warning">Pedidos</h5>
                                    <h3 class="text-warning" th:text="${pedidos != null} ? ${#lists.size(pedidos)} : '0'">0</h3>
                                    <p class="card-text">En proceso</p>
                                </div>
                                <div class="report-icon">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom report-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title text-info">Promedio Venta</h5>
                                    <h3 class="text-info" th:text="${estadisticasVentas?.promedioVenta != null} ? '$' + ${#numbers.formatDecimal(estadisticasVentas.promedioVenta, 0, 'DEFAULT', 0, 'DEFAULT')} : '$0'">$0</h3>
                                    <p class="card-text">Por transacción</p>
                                </div>
                                <div class="report-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enlaces a informes detallados -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card card-custom report-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Informe de Ventas</h5>
                                    <p class="card-text">Análisis detallado de ventas por período</p>
                                </div>
                                <div class="report-icon">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <a th:href="@{/informes/ventas(fechaInicio=${fechaInicio}, fechaFin=${fechaFin})}" 
                                   class="btn btn-outline-custom me-2">
                                    <i class="fas fa-eye me-2"></i>Ver Detalle
                                </a>
                                <button class="btn btn-outline-secondary" id="btnExportarVentas">
                                    <i class="fas fa-download me-2"></i>Descargar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-custom report-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Informe de Cotizaciones</h5>
                                    <p class="card-text">Seguimiento de cotizaciones y conversión</p>
                                </div>
                                <div class="report-icon">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <a th:href="@{/informes/cotizaciones(fechaInicio=${fechaInicio}, fechaFin=${fechaFin})}" 
                                   class="btn btn-outline-custom me-2">
                                    <i class="fas fa-eye me-2"></i>Ver Detalle
                                </a>
                                <button class="btn btn-outline-secondary" id="btnExportarCotizaciones">
                                    <i class="fas fa-download me-2"></i>Descargar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-custom report-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Informe de Pedidos</h5>
                                    <p class="card-text">Estado y seguimiento de pedidos</p>
                                </div>
                                <div class="report-icon">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <a th:href="@{/informes/pedidos(fechaInicio=${fechaInicio}, fechaFin=${fechaFin})}" 
                                   class="btn btn-outline-custom me-2">
                                    <i class="fas fa-eye me-2"></i>Ver Detalle
                                </a>
                                <button class="btn btn-outline-secondary" id="btnExportarPedidos">
                                    <i class="fas fa-download me-2"></i>Descargar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="date-range-picker">
                        <h5 class="mb-3"><i class="fas fa-calendar-alt me-2"></i> Seleccionar Período</h5>
                        <form th:action="@{/informes}" method="post" id="filtroForm">
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <label for="startDate" class="form-label">Fecha Inicio</label>
                                    <input type="date" class="form-control" id="startDate" name="startDate" 
                                           th:value="${fechaInicio != null} ? ${#temporals.format(fechaInicio, 'yyyy-MM-dd')} : ''">
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label for="endDate" class="form-label">Fecha Fin</label>
                                    <input type="date" class="form-control" id="endDate" name="endDate"
                                           th:value="${fechaFin != null} ? ${#temporals.format(fechaFin, 'yyyy-MM-dd')} : ''">
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label for="reportType" class="form-label">Tipo de Informe</label>
                                    <select class="form-select" id="reportType" name="reportType">
                                        <option value="Resumen General" selected>Resumen General</option>
                                        <option value="Resumen Detallado">Resumen Detallado</option>
                                        <option value="Vendedor">Vendedor</option>
                                        <option value="Cliente">Cliente</option>
                                        <option value="Producto">Producto</option>
                                        <option value="Cotización">Cotización</option>
                                        <option value="Pedido">Pedido</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end mb-2">
                                    <button type="submit" class="btn btn-custom w-100">
                                        <i class="fas fa-filter me-2"></i>Filtrar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Gráficos y Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Ventas Mensuales</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" id="btnImprimirVentas">
                                    <i class="fas fa-print me-1"></i>Imprimir
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" id="btnExportarGraficoVentas">
                                    <i class="fas fa-download me-1"></i>Excel
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="salesChart"></canvas>
                            </div>
                            <div class="text-center mt-3">
                                <h6 class="text-success">Nota: El valor de las ventas es expresado en miles</h6>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-custom h-100">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0">Resumen de Ventas</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <span>Total Ventas:</span>
                                <span class="fw-bold" th:text="${estadisticasVentas?.totalIngresos != null} ? '$' + ${#numbers.formatDecimal(estadisticasVentas.totalIngresos, 0, 'DEFAULT', 0, 'DEFAULT')} : '$0'">$0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Ventas Promedio:</span>
                                <span class="fw-bold" th:text="${estadisticasVentas?.promedioVenta != null} ? '$' + ${#numbers.formatDecimal(estadisticasVentas.promedioVenta, 0, 'DEFAULT', 0, 'DEFAULT')} : '$0'">$0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Cantidad de Transacciones:</span>
                                <span class="fw-bold" th:text="${estadisticasVentas?.totalVentas != null} ? ${estadisticasVentas.totalVentas} : '0'">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Pagos en Efectivo:</span>
                                <span class="fw-bold" th:text="${estadisticasVentas?.totalEfectivo != null} ? '$' + ${#numbers.formatDecimal(estadisticasVentas.totalEfectivo, 0, 'DEFAULT', 0, 'DEFAULT')} : '$0'">$0</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold text-success">
                                <span>Período:</span>
                                <span th:text="${fechaInicio != null} ? ${#temporals.format(fechaInicio, 'dd/MM/yyyy')} + ' - ' + ${#temporals.format(fechaFin, 'dd/MM/yyyy')} : 'No especificado'">
                                    No especificado
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Más gráficos -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0">Estado de Cotizaciones</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="quotesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0">Tasa de Conversión</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="conversionChart"></canvas>
                            </div>
                            <div class="text-center mt-3">
                                <h6 class="text-success">75% de conversión de cotización a venta</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tabla de Pedidos -->
            <div class="card card-custom mb-4">
                <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Detalle de Pedidos</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" id="btnImprimirTabla">
                            <i class="fas fa-print me-1"></i>Imprimir
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="btnExportarTabla">
                            <i class="fas fa-download me-1"></i>Exportar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tablaPedidos">
                            <thead>
                                <tr>
                                    <th>N° Factura</th>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Productos</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:if="${#lists.isEmpty(pedidos)}">
                                    <td colspan="6" class="text-center">No hay pedidos en el período seleccionado</td>
                                </tr>
                                <tr th:each="pedido : ${pedidos}">
                                    <td th:text="${pedido.numeroPedido}">PED-001</td>
                                    <td th:text="${pedido.cliente}">Cliente Ejemplo</td>
                                    <td th:text="${pedido.fecha != null} ? ${#temporals.format(pedido.fecha, 'dd/MM/yyyy')} : 'N/A'">01/01/2024</td>
                                    <td th:text="${pedido.cantidadProductos}">5</td>
                                    <td th:text="${pedido.total != null} ? '$' + ${#numbers.formatDecimal(pedido.total, 0, 'DEFAULT', 0, 'DEFAULT')} : '$0'">$0</td>
                                    <td>
                                        <span th:classappend="${pedido.estado == 'COMPLETADA'} ? 'badge bg-success' : 
                                              ${pedido.estado == 'PENDIENTE'} ? 'badge bg-warning text-dark' : 
                                              ${pedido.estado == 'CANCELADA'} ? 'badge bg-danger' : 
                                              'badge bg-secondary'"
                                              th:text="${pedido.estado}">PENDIENTE</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Scripts específicos para informes -->
<th:block layout:fragment="scripts">
    <script th:src="@{/js/informes.js}"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Datos para gráficos desde el servidor
        const ventasMensuales = /*[[${ventasMensuales != null} ? ${ventasMensuales} : [0,0,0,0,0,0,0,0,0,0,0,0]]]*/ [400, 420, 430, 490, 450, 460, 400, 490, 510, 520, 540, 570];
        const estadosCotizaciones = /*[[${estadosCotizaciones != null} ? ${estadosCotizaciones} : [0,0,0,0]]]*/ [45, 15, 8, 5];
        const tasaConversion = /*[[${tasaConversion != null} ? ${tasaConversion} : [0,0,0,0,0,0]]]*/ [55, 60, 64, 69, 73, 75];

        // URLs para exportación
        const baseUrl = /*[[@{/}]]*/ '';
        const fechaInicio = /*[[${fechaInicio != null} ? ${#temporals.format(fechaInicio, 'yyyy-MM-dd')} : '']]*/ '';
        const fechaFin = /*[[${fechaFin != null} ? ${#temporals.format(fechaFin, 'yyyy-MM-dd')} : '']]*/ '';
        /*]]>*/
    </script>
</th:block>
</body>
</html>